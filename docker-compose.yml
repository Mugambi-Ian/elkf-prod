services:
    init-certs:
      image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
      command: >
        bash -c "
          if [ ! -f /usr/share/elasticsearch/config/certs/elastic-certificates.p12 ]; then
            echo 'ERROR: Certificate file not found! Run: docker compose --profile cert_gen run --rm cert_gen';
            exit 1;
          fi;
          echo 'Certificate file found, verifying permissions...';
          chown -R 1000:1000 /usr/share/elasticsearch/config/certs;
          chmod 600 /usr/share/elasticsearch/config/certs/elastic-certificates.p12;
          echo 'Permissions set correctly';
          ls -lh /usr/share/elasticsearch/config/certs/elastic-certificates.p12;
        "
      user: root
      volumes:
        - certs:/usr/share/elasticsearch/config/certs
      healthcheck:
        test: ["CMD-SHELL", "test -f /usr/share/elasticsearch/config/certs/elastic-certificates.p12 && test -r /usr/share/elasticsearch/config/certs/elastic-certificates.p12"]
        interval: 1s
        retries: 5

    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
      container_name: elasticsearch
      hostname: elasticsearch
      volumes:
        - es-data:/usr/share/elasticsearch/data
        - ./logs/elasticsearch:/usr/share/elasticsearch/logs
        - certs:/usr/share/elasticsearch/config/certs
      environment:
        - node.name=elasticsearch
        - xpack.security.enabled=true
        - xpack.security.transport.ssl.enabled=true
        - xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certs/elastic-certificates.p12
        - xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certs/elastic-certificates.p12
        - xpack.security.transport.ssl.keystore.password=${CERTS_PASSWORD}
        - xpack.security.transport.ssl.truststore.password=${CERTS_PASSWORD}
        - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
        - discovery.type=single-node
      deploy:
        resources:
          limits:
            cpus: '4.0'
            memory: 4g
      healthcheck:
        test: [ "CMD-SHELL", "curl -u elastic:${ELASTIC_PASSWORD} -sS http://localhost:9200/_cluster/health || exit 1" ]
        interval: 30s
        timeout: 10s
        retries: 5
        start_period: 60s  # Give ES more time to start initially
      depends_on:
        init-certs:
          condition: service_completed_successfully

    logstash:
      image: docker.elastic.co/logstash/logstash:8.12.0
      environment:
        - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      volumes:
        - ./logstash/pipeline:/usr/share/logstash/pipeline
        - ./logs/logstash:/usr/share/logstash/logs # Mount Logstash logs for inspection
      deploy:
        resources:
          limits:
            cpus: '0.5'
            memory: 1g

    filebeat:
      image: docker.elastic.co/beats/filebeat:8.12.0
      # user: root # Removed for least privilege
      volumes:
        - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
        - app-logs:/usr/local/var/log:ro
      depends_on:
        - logstash
      deploy:
        resources:
          limits:
            cpus: '0.2'
            memory: 256m

    kibana:
      image: docker.elastic.co/kibana/kibana:8.12.0
      environment:
        - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        - ELASTICSEARCH_USERNAME=kibana_system
        - ELASTICSEARCH_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
        - xpack.security.enabled=true
      # ports:
      #   - "5601:5601" # Port exposure handled by Nginx
      depends_on:
        elasticsearch:
          condition: service_healthy
      healthcheck:
        test: ["CMD-SHELL", "curl -sS http://localhost:5601/api/status | grep -q '\"state\":\"green\"'"]
        interval: 10s
        timeout: 10s
        retries: 12
      deploy:
        resources:
          limits:
            cpus: '0.5'
            memory: 1g

    nginx:
      image: nginx:stable-alpine
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
        - certbot-webroot:/var/www/certbot:rw # Volume for certbot challenges
        - certbot-certs:/etc/letsencrypt:rw # Volume for certbot certificates
      depends_on:
        kibana:
          condition: service_healthy
      environment:
        - KIBANA_DOMAIN=${KIBANA_DOMAIN}
      deploy:
        resources:
          limits:
            cpus: '0.2'
            memory: 128m

    cert_gen:
      image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
      command: >
        bash -c '
          set -e;
          echo "Generating certificates...";
          mkdir -p /usr/share/elasticsearch/config/certs;
          CERT_PATH=/usr/share/elasticsearch/config/certs/elastic-certificates.p12;
          
          # Generate self-signed certificate with explicit output path
          elasticsearch-certutil cert --self-signed --name elasticsearch --dns elasticsearch --dns localhost --ip 127.0.0.1 --ip ::1 -out "$$CERT_PATH" -pass "${CERTS_PASSWORD}";
          
          # Extract certificate to temp file
          openssl pkcs12 -in "$$CERT_PATH" -nokeys -out /tmp/cert.crt -passin pass:"${CERTS_PASSWORD}" -passout pass:;
          
          # Import the certificate as a trusted entry into the same keystore
          # keytool is in the JDK directory
          /usr/share/elasticsearch/jdk/bin/keytool -importcert -noprompt -alias elasticsearch-ca -file /tmp/cert.crt -keystore "$$CERT_PATH" -storetype PKCS12 -storepass "${CERTS_PASSWORD}" -trustcacerts;
          
          rm -f /tmp/cert.crt;
          chown -R 1000:1000 /usr/share/elasticsearch/config/certs;
          chmod 600 "$$CERT_PATH";
          echo "Certificates generated successfully at $$CERT_PATH";
        '
      volumes:
        - certs:/usr/share/elasticsearch/config/certs
      environment:
        - ES_JAVA_OPTS=-Xms512m -Xmx512m
        - CERTS_PASSWORD=${CERTS_PASSWORD}
      container_name: cert_gen_container
      user: root
      profiles: ["cert_gen"]
volumes:
  es-data:
  app-logs:
    external: true
  certbot-webroot: # Volume for certbot challenges
  certbot-certs: # Volume for certbot certificates
  certs: # New volume for certificates

