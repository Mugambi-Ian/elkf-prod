version: "3.9"

services:
  cert_gen:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: cert_gen
    user: root
    volumes:
      - certs:/usr/share/elasticsearch/config/certs
    command: >
      bash -c '
        set -e;
        mkdir -p config/certs;
        elasticsearch-certutil ca --silent --pem -out config/certs/ca.zip;
        unzip -o config/certs/ca.zip -d config/certs;
        elasticsearch-certutil cert --silent --pem \
          --ca-cert config/certs/ca/ca.crt \
          --ca-key  config/certs/ca/ca.key \
          --dns elasticsearch --dns localhost \
          --ip 127.0.0.1 \
          -out config/certs/es.zip;
        unzip -o config/certs/es.zip -d config/certs;
        chown -R 1000:1000 config/certs;
        find config/certs -type d -exec chmod 750 {} \;
        find config/certs -type f -name "*.key" -exec chmod 600 {} \;
        find config/certs -type f -name "*.crt" -exec chmod 644 {} \;
        chown -R 1000:1000 config/certs;
      '

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: elasticsearch
    depends_on:
      cert_gen:
        condition: service_completed_successfully
    volumes:
      - es-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs
    environment:
      node.name: elasticsearch
      discovery.type: single-node
      xpack.security.enabled: true
      xpack.security.transport.ssl.enabled: true
      xpack.security.transport.ssl.key: certs/instance/instance.key
      xpack.security.transport.ssl.certificate: certs/instance/instance.crt
      xpack.security.transport.ssl.certificate_authorities: certs/ca/ca.crt

      xpack.security.http.ssl.enabled: true
      xpack.security.http.ssl.key: certs/instance/instance.key
      xpack.security.http.ssl.certificate: certs/instance/instance.crt
      xpack.security.http.ssl.certificate_authorities: certs/ca/ca.crt

      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "curl -k -u elastic:${ELASTIC_PASSWORD} https://localhost:9200 >/dev/null"]
      interval: 10s
      retries: 30

  es_bootstrap:
    image: curlimages/curl:8.5.0
    container_name: es_bootstrap
    user: root
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - secrets:/secrets
      - certs:/certs:ro
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      KIBANA_SYSTEM_PASSWORD: ${KIBANA_SYSTEM_PASSWORD}
    command: >
      sh -c '
        set -e;

        echo "Waiting for Elasticsearch...";
        until curl -sk -u elastic:${ELASTIC_PASSWORD} https://elasticsearch:9200 >/dev/null; do
          sleep 2;
        done;

        echo "Setting kibana_system password...";
        curl -sk -u elastic:${ELASTIC_PASSWORD} \
          -X POST https://elasticsearch:9200/_security/user/kibana_system/_password \
          -H "Content-Type: application/json" \
          -d "{\"password\":\"${KIBANA_SYSTEM_PASSWORD}\"}";

        echo "Creating Logstash API key...";
        API_KEY=$(curl -sk -u elastic:${ELASTIC_PASSWORD} \
          -X POST "https://elasticsearch:9200/_security/api_key?filter_path=encoded" \
          -H "Content-Type: application/json" \
          -d "{
            \"name\": \"logstash-ingest\",
            \"role_descriptors\": {
              \"logstash_writer\": {
                \"cluster\": [\"monitor\"],
                \"index\": [{
                  \"names\": [\"logs-*\"],
                  \"privileges\": [\"create_index\",\"create\",\"write\"]
                }]
              }
            }
          }" | sed -n "s/.*\"encoded\":\"\\([^\"]*\\)\".*/\\1/p");

        echo \"$API_KEY\" > /secrets/logstash_api_key;
        chmod 600 /secrets/logstash_api_key;

        echo \"Bootstrap completed successfully\";
      '

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.0
    depends_on:
      es_bootstrap:
        condition: service_completed_successfully
    volumes:
      - certs:/usr/share/kibana/config/certs:ro
    environment:
      ELASTICSEARCH_HOSTS: https://elasticsearch:9200
      ELASTICSEARCH_USERNAME: kibana_system
      ELASTICSEARCH_PASSWORD: ${KIBANA_SYSTEM_PASSWORD}
      ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES: /usr/share/kibana/config/certs/ca/ca.crt
    ports:
        - "5601:5601"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.12.0
    depends_on:
      es_bootstrap:
        condition: service_completed_successfully
    volumes:
      - certs:/certs:ro
      - secrets:/secrets:ro
      - ./logstash/pipeline:/usr/share/logstash/pipeline
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      LOGSTASH_API_KEY_FILE: /secrets/logstash_api_key

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.12.0
    user: root
    depends_on:
      - logstash
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - app-logs:/usr/local/var/log:ro

volumes:
  es-data:
  certs:
  secrets:
  app-logs:
    external: true
